     1                                  ; use_cpuid.asm
     2                                  extern printf
     3                                  section .data
     4 00000000 546869732063707520-             fmt_no_sse           db        "This cpu does not support SSE",10,0
     4 00000009 646F6573206E6F7420-
     4 00000012 737570706F72742053-
     4 0000001B 53450A00           
     5 0000001F 546869732063707520-             fmt_sse42            db        "This cpu supports SSE 4.2",10,0
     5 00000028 737570706F72747320-
     5 00000031 53534520342E320A00 
     6 0000003A 546869732063707520-             fmt_sse41            db        "This cpu supports SSE 4.1",10,0
     6 00000043 737570706F72747320-
     6 0000004C 53534520342E310A00 
     7 00000055 546869732063707520-             fmt_ssse3            db        "This cpu supports SSSE 3",10,0
     7 0000005E 737570706F72747320-
     7 00000067 5353534520330A00   
     8 0000006F 546869732063707520-             fmt_sse3             db        "This cpu supports SSE 3",10,0
     8 00000078 737570706F72747320-
     8 00000081 53534520330A00     
     9 00000088 546869732063707520-             fmt_sse2             db        "This cpu supports SSE 2",10,0
     9 00000091 737570706F72747320-
     9 0000009A 53534520320A00     
    10 000000A1 546869732063707520-             fmt_sse              db        "This cpu supports SSE",10,0
    10 000000AA 737570706F72747320-
    10 000000B3 5353450A00         
    11                                  section .bss
    12                                  section .text
    13                                        global main
    14                                  main:
    15 00000000 4889E5                      mov rbp, rsp; for correct debugging
    16 00000003 55                      push  rbp                                     ; Пролог функции.
    17 00000004 4889E5                  mov   rbp, rsp                                ; Пролог функции.
    18 00000007 E802000000                    call    cpu_sse                         ; Возвращает 1 в rax, если поддерживается sse, иначе 0.
    19 0000000C C9                      leave
    20 0000000D C3                      ret
    21                                  
    22                                  cpu_sse:
    23 0000000E 55                              push  rbp                             ; Пролог функции.
    24 0000000F 4889E5                          mov   rbp, rsp                        ; Пролог функции.
    25 00000012 4D31E4                          xor   r12, r12                        ; Флаг SSE доступен.
    26 00000015 B801000000                      mov   eax, 1                          ; Запрос флагов характеристик ЦПУ.
    27 0000001A 0FA2                            cpuid
    28                                  ; Проверка поддержки SSE.
    29 0000001C F7C200000002                    test  edx, 2000000h                   ; Проверка бита 25 (SSE).
    30 00000022 741C                            jz    sse2                            ; SSE-инструкции доступны.
    31 00000024 41BC01000000                    mov   r12, 1
    32 0000002A 4831C0                          xor   rax, rax
    33 0000002D 48BF-                           mov   rdi, fmt_sse
    33 0000002F [A100000000000000] 
    34 00000037 51                              push  rcx                             ; Изменяется функцией printf.
    35 00000038 52                              push  rdx                             ; Сохранение результата cpuid.
    36 00000039 E8(00000000)                    call  printf
    37 0000003E 5A                              pop   rdx
    38 0000003F 59                              pop   rcx
    39                                     sse2:
    40 00000040 F7C200000004                    test  edx, 4000000h                   ; Проверка бита 26 (SSE 2).
    41 00000046 741C                            jz    sse3                            ; Версия SSE 2 доступна.
    42 00000048 41BC01000000                    mov   r12, 1
    43 0000004E 4831C0                          xor   rax, rax
    44 00000051 48BF-                           mov   rdi, fmt_sse2
    44 00000053 [8800000000000000] 
    45 0000005B 51                              push  rcx                             ; Изменяется функцией printf.
    46 0000005C 52                              push  rdx                             ; Сохранение результата cpuid.
    47 0000005D E8(00000000)                    call  printf
    48 00000062 5A                              pop   rdx
    49 00000063 59                              pop   rcx
    50                                     sse3: 
    51 00000064 F7C101000000                    test  ecx, 1                          ; Проверка бита 0 (SSE 3).
    52 0000006A 741C                            jz    ssse3                           ; Версия SSE 3 доступна.
    53 0000006C 41BC01000000                    mov   r12, 1
    54 00000072 4831C0                          xor   rax, rax
    55 00000075 48BF-                           mov   rdi, fmt_sse3
    55 00000077 [6F00000000000000] 
    56 0000007F 51                              push  rcx                             ; Изменяется функцией printf.
    57 00000080 55                              push  rbp
    58 00000081 E8(00000000)                    call  printf  
    59 00000086 5D                              pop   rbp     
    60 00000087 59                              pop   rcx
    61                                     ssse3:
    62 00000088 F7C109000000                    test  ecx, 9h                         ; Проверка битов 0 и 3 (SSSE 3).
    63 0000008E 741C                            jz    sse41                           ; Версия SSSE 3 доступна.
    64 00000090 41BC01000000                    mov   r12, 1
    65 00000096 4831C0                          xor   rax, rax
    66 00000099 48BF-                           mov   rdi, fmt_ssse3
    66 0000009B [5500000000000000] 
    67 000000A3 51                              push  rcx                             ; Изменяется функцией printf.
    68 000000A4 55                              push  rbp
    69 000000A5 E8(00000000)                    call  printf 
    70 000000AA 5D                              pop   rbp      
    71 000000AB 59                              pop   rcx
    72                                    sse41:
    73 000000AC F7C100000800                    test  ecx, 80000h                     ; Проверка бита 0 (SSE 4.1).
    74 000000B2 741C                            jz    sse42                           ; Версия SSE 4.1 доступна.
    75 000000B4 41BC01000000                    mov   r12, 1
    76 000000BA 4831C0                          xor   rax, rax
    77 000000BD 48BF-                           mov   rdi, fmt_sse41
    77 000000BF [3A00000000000000] 
    78 000000C7 51                              push  rcx                             ; Изменяется функцией printf.
    79 000000C8 55                              push  rbp
    80 000000C9 E8(00000000)                    call  printf
    81 000000CE 55                              push  rbp
    82 000000CF 59                              pop   rcx
    83                                          
    84                                    sse42:
    85 000000D0 F7C100001000                    test  ecx, 100000h                    ; Проверка бита 20 (SSE 4.2).
    86 000000D6 741C                            jz    wrapup                          ; Версия SSE 4.2 доступна.
    87 000000D8 41BC01000000                    mov   r12, 1
    88 000000DE 4831C0                          xor   rax, rax
    89 000000E1 48BF-                           mov   rdi, fmt_sse42
    89 000000E3 [1F00000000000000] 
    90 000000EB 51                              push  rcx                             ; Изменяется функцией printf.
    91 000000EC 55                              push  rbp
    92 000000ED E8(00000000)                    call  printf
    93 000000F2 55                              push  rbp
    94 000000F3 59                              pop   rcx 
    95                                   wrapup:
    96 000000F4 4983FC01                        cmp   r12, 1
    97 000000F8 7414                            je    sse_ok
    98 000000FA 48BF-                           mov   rdi, fmt_no_sse
    98 000000FC [0000000000000000] 
    99 00000104 4831C0                          xor   rax, rax
   100 00000107 E8(00000000)                    call  printf                          ; Вывод сообщения, если SSE-инструкции недоступны.
   101 0000010C EB03                            jmp   the_exit                        
   102                                   sse_ok:
   103 0000010E 4C89E0                          mov   rax, r12                        ; Возвращает 1, SSE-инструкции поддерживаются.
   104                                  the_exit:
   105 00000111 C9                      leave
   106 00000112 C3                      ret
   107                                          
